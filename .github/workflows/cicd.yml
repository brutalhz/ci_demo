name: CI + CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Compile
        run: echo Hello, world!
    
  DeployDev:
    name: Deploy to Dev 
    if: github.event.ref == 'refs/heads/main' 
    needs: [Build]
    runs-on: ubuntu-latest
    environment: 
      name: Development
      url: 'http://dev.myapp.com'
    outputs:
      IMAGE_TAG: ${{ steps.check-tag.outputs.IMAGE_ID }}
    steps:
      - name: Deploy
        run: echo I am deploying!

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check Tag
        id: check-tag
        run: |
           if [[ ${{ github.event.ref }} =~ ^refs/tags/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
               echo "::set-output name=IMAGE_ID::${{ github.ref_name }}"
           else
             ts=$(date +%Y%m%d-%H.%M | awk -F- '{print $1 "-" sprintf("%02d", ($2 + 3) % 24) "." substr($2, 4)}')
             branch=dev
             echo "::set-output name=IMAGE_ID::${branch}-${GITHUB_SHA::8}-${ts}"
             echo "IMAGE_ID=${branch}-${GITHUB_SHA::8}-${ts}" >> $GITHUB_ENV
           fi

  create-release-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"

      - name: Create release branch
        run: |
          git checkout -b release
          git push origin release


